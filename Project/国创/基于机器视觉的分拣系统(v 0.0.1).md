# 基于机器视觉的分拣系统(v 0.0.2)

## 用户体验

### **体验流程：画漫画的形式，明确用户需求。**



统一使用树莓派 3B



**目标**：

1. 通过现有的`视觉检测模型`完成杂乱物件的分类；
2. 上传训练用户的`视觉检测模型`完成训练，并进行预测检验`视觉检测模型`的正确性。

**说明**：传送带是模块化的，一个传送带模块包含：控制电路板(树莓派)、摄像头、步进电机、拨杆。需要完成多类物件的分拣可通过组合多个传送带进行二分类来实现。以最简单的情况，实现物件的二分类为例：

### 入门使用  

![预测](E:\国创-分拣系统\预测.jpg)

- **使用现有模型预测** ：

1. 如上图，用户进入 web 管理平台，选择预测模式；

2. 此时平台库中已有如 openCV、OCR、SSD 等可直接使用的特征模型；

3. 用户选择一个特征模型用于物件检测，并在传送带上准备好待分拣的物件，最后在 Web 管理平台控制分拣系统开始工作。

4. 系统工作开始，摄像头会捕获视频流，作为上位机的树莓派会完成对物体图像的定位和识别，并将物体检测的结果(物体的颜色、形状、大小、已分拣的数目等) 通过 `wifi`（或者有线？） 传送给控制拨片的步进电机和web 管理平台做为数据看板；

5. 用户可通过数据看板随时监控分拣的情况，并通过 web 平台控制系统的开始与结束。
6. 步进电机则根据树莓派得出的物件种类和空间位置，控制拨片将物件分拨到两个不同的传送带上，最终落入物料盒，分拣结束。



### 进阶使用  

![训练](E:\国创-分拣系统\训练.jpg)

- **用户通过 web 管理平台训练自己的模型**：

1. 如上图，用户进入 web 管理平台，选择训练模式；
2. 平台库中已有如  Yolo，SSD 等深度学习模型的预训练权重；
3. 在该模式下，传感器1会慢速运动，摄像机为该物件拍摄一段运动中的视频并逐帧转换为多张图像，传感器2和传感器3 停止工作；
4. 用户通过 web 管理平台，上传自己未经训练的模型及预训练模型权重(也可上传平台库中已有的)，并为拍摄的物体图像打上对应的标签，将这些图像和标签作为训练集。
5. web 平台将模型和训练集共同上传到 AI Cloud,  在 web 平台控制 AI Cloud 对模型进行训练。
6. 用户可以不断更新物体检测模型（调参），更深入地了解机器学习和计算机视觉。

- **用户搭建新的传送带**：

1. 传送带是模块化的，需要完成多类分拣可通过组合多个传送带进行二分类来实现。
2. 用户可组装摄像头伺服电机和控制模块等做成一个新的传送带添加到分拣系统中，并通过 web 管理平台为其对应的控制模块(树莓派)写入不同的物体检测模型，作为物联网的入门。



## 开发思路

### **系统管理**

0. 在 web 管理平台上，可以控制系统流程的开始与结束，选择对应的`识别模型`，并观察中间的生成结果。

   (涉及技术：web 端服务器设计与搭建)



### **系统开始**

系统开始后有三个共通的步骤：

1. **相机标定**：为系统建立一个三维坐标系，对从摄像头采集到的图像进行处理，以判定目标对象在三维坐标系中所处的位置；

   (涉及技术：三维坐标系建立，摄像机标定)

2. **图像处理**：在物件进入视觉系统的采集区域后，将图像数据送到树莓派，树莓派对相机拍摄到的图像进行预处理，提高图像信噪比，减轻后续图像处理的压力。 

   (涉及技术：树莓派与摄像头通信机制，树莓派视频流处理库，提高图像信噪比，抑制背景噪声)

3. **特征提取**：对预处理好的图像，树莓派使用边缘检测算子抠出物件边缘，提取图像特征，如颜色、长度、面积等。

   (涉及技术：边缘检测（二值化，图像卷积，膨胀）)



接下来，系统有**两种运行模式**：训练模式与预测模式。

### **训练模式**

4. **特征采集**：采集图像经过特征提取后的结果，保存为图像。

   (涉及技术：树莓派与 AI Cloud 通信，特征图像的批量保存)

5. **模型训练**：手动将特征采集的图像打好标签，`上传到 AI Cloud`，进行训练。

   (涉及技术：web平台图像打标工具，图像和标签的上传，web 端模型选择）

6. **特征库建立**：AI Cloud 将训练好的模型保留到特征库，供后续的预测，流程结束。

   (涉及技术：云端模型的训练和保存)



### **预测模式**

4. **特征模型选择**：用户可在 Web 管理平台上选择希望使用的预测模型

   (涉及技术：web 端模型选择，与 AI Cloud 通信)

5. **目标识别**：采用web模型管理平台预先选取的方法，树莓派将`采集的图像上传到 AI Cloud `(?)，识别出目标物件，对识别出的物件进行标定。

   (涉及技术：树莓派与 AI Cloud 通信，模型预测，图像识别)

6. **目标定位**：根据这些特征来确定出中心坐标，图像中目标物件的位置决定了它在空间的位置。

   (涉及技术：边缘直线检测(Hough 变换)，计算物件质心坐标(图像一阶矩))

7. **目标拾取**：将标定的物件的位姿结果反馈给PLC，PLC控制机械臂驱动关节（或电磁推杆）运动执行拾取工件操作。

   (涉及技术: 树莓派与PLC通信，PLC 控制，机械臂或机械推杆控制)

8. **目标放置**：将目标放置在指定的位置，流程结束。



## 技术栈

| 系统步骤     | 涉及技术                                                     | 技术实现                         |
| :----------- | ------------------------------------------------------------ | -------------------------------- |
| 相机标定     | 三维坐标系建立，摄像机标定                                   | 标定方法                         |
| 图像处理     | 树莓派与摄像头通信机制，树莓派视频流处理库，提高图像信噪比，抑制背景噪声 | wifi或网线通信，图像平滑         |
| 特征提取     | 边缘检测（二值化，图像卷积，膨胀）                           | OpenCV canny 算子                |
| 特征采集     | 树莓派与 AI Cloud 通信，特征图像的批量保存                   | wifi或网线通信，图像存储         |
| 模型训练     | web平台图像打标工具，图像和标签的上传，web 端选择预训练模型  | Node-RED, Node，web 服务器       |
| 特征库建立   | 云端模型的训练和保存                                         | TensorFlow 模型训练              |
| 特征模型选择 | web 端模型选择，与 AI Cloud 通信                             | Node-RED，Node，web 服务器       |
| 目标识别     | 树莓派与 AI Cloud 通信，模型预测，图像识别                   | TensorFlow 模型预测              |
| 目标定位     | 边缘直线检测，计算物件质心坐标                               | Hough 变换基于，图像不变矩求质心 |
| 目标拾取     | 树莓派与PLC通信，PLC 控制，机械臂或推杆控制                  | PLC，机械臂或推杆                |
| 目标放置     | 机械臂或推杆控制                                             | 机械臂或推杆                     |



## 流程图

![分拣工作流程](E:\OneDrive - business\Draw.io\分拣工作流程.png)



![分拣工作流程 (2)](/home/nicholascheng/Downloads/分拣工作流程 (2).png)